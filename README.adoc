= RIOT: Redis Input Output Tool
// Settings
:idprefix:
:idseparator: -
ifdef::env-github,env-browser[:outfilesuffix: .adoc]
:toc: preamble
endif::[]
ifndef::env-github[:icons: font]
// URIs
:project-repo: Redislabs-Solution-Architects/riot
:uri-repo: https://github.com/{project-repo}
// GitHub customization
ifdef::env-github[]
:badges:
:tag: master
:!toc-title:
:tip-caption: :bulb:
:note-caption: :paperclip:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

----
█████╗ ██╗ █████╗██████╗
██╔═██╗██║██╔══██╚═██╔═╝
█████╔╝██║██║  ██║ ██║
██╔═██╗██║╚█████╔╝ ██║
╚═╝ ╚═╝╚═╝ ╚════╝  ╚═╝
----
RIOT is a data import/export tool for Redis and Redis Modules that connects to various sources and targets: files, databases, data generators, ...

ifdef::show-svg[]
image::https://redislabs-solution-architects.github.io/riot/riot-import-json.svg[Import JSON]
endif::[]

== Getting Started
Download the https://github.com/Redislabs-Solution-Architects/riot/releases/latest[latest RIOT distribution] (zip or tar.gz) and unpack the downloaded archive.

Launch the `riot` script (`riot.bat` for Windows) and follow the usage information provided.

== Relational Databases

RIOT can connect to any RDBMS with a JDBC driver.

=== Setup

WARNING: Add the JDBC driver jar for your database under the `lib` directory. +
e.g. for MySQL: `lib/mysql-connector-java-5.1.47.jar`.

==== MS SQL Server
https://docs.microsoft.com/en-us/sql/connect/jdbc/microsoft-jdbc-driver-for-sql-server[Microsoft JDBC Driver]

https://docs.microsoft.com/en-us/sql/connect/jdbc/building-the-connection-url?view=sql-server-2017[Building the connection URL]

==== MySQL
https://dev.mysql.com/downloads/connector/j/[MySQL Connector/J]

https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-reference-jdbc-url-format.html[Connection URL Syntax]
[source,plaintext]
----
jdbc:sqlserver://[serverName[\instanceName][:portNumber]][;property=value[;property=value]]
----

=== RDBMS -> Redis
Let's use the following MySQL database table from https://dev.mysql.com/doc/employee/en/[mysql.com]: 
[source,plaintext]
----
mysql> describe employees;
+------------+---------------+------+-----+---------+-------+
| Field      | Type          | Null | Key | Default | Extra |
+------------+---------------+------+-----+---------+-------+
| emp_no     | int(11)       | NO   | PRI | NULL    |       |
| birth_date | date          | NO   |     | NULL    |       |
| first_name | varchar(14)   | NO   |     | NULL    |       |
| last_name  | varchar(16)   | NO   |     | NULL    |       |
| gender     | enum('M','F') | NO   |     | NULL    |       |
| hire_date  | date          | NO   |     | NULL    |       |
+------------+---------------+------+-----+---------+-------+
6 rows in set (0.01 sec)
----

To import the whole table run the following command:
[source,shell]
----
riot db --url "jdbc:mysql://localhost:3306/employees?serverTimezone=PST&useLegacyDatetimeCode=false&useSSL=false" --username root --password --sql "select * from employees" redis --keyspace employee --keys emp_no
----

=== Redis -> RDBMS
This command exports all hashes under keyspace `beer:<id>` to MySQL: 
[source,shell]
----
riot redis --keyspace beer --keys id db --url "jdbc:mysql://localhost:3306/employees?serverTimezone=PST&useLegacyDatetimeCode=false&useSSL=false" --username root --password --sql "INSERT INTO beers (id, name, style_name) VALUES (:id, :name, :style_name)"
----

== Delimited Files (CSV)

Here is an excerpt of https://raw.githubusercontent.com/jpatokal/openflights/master/data/airports.dat[airports.dat] CSV data available at https://github.com/jpatokal/openflights[openflights]
----
1,"Goroka Airport","Goroka","Papua New Guinea","GKA","AYGA",-6.081689834590001,145.391998291,5282,10,"U","Pacific/Port_Moresby","airport","OurAirports"
2,"Madang Airport","Madang","Papua New Guinea","MAG","AYMD",-5.20707988739,145.789001465,20,10,"U","Pacific/Port_Moresby","airport","OurAirports"
3,"Mount Hagen Kagamuga Airport","Mount Hagen","Papua New Guinea","HGU","AYMH",-5.826789855957031,144.29600524902344,5388,10,"U","Pacific/Port_Moresby","airport","OurAirports"
----

=== CSV -> Redis
[source,shell]
----
riot csv --url https://raw.githubusercontent.com/jpatokal/openflights/master/data/airports.dat --fields AirportID Name City Country IATA ICAO Latitude Longitude Altitude Timezone DST Tz Type Source redis --type geo --keyspace airportgeo --fields AirportID --lon Longitude --lat Latitude
----

Query the `airportgeo` geoset using redis-cli
[source,plaintext]
----
> GEORADIUS airportgeo -122.4194 37.7749 20 mi
1) "3469"
2) "10360"
3) "8982"
…
----

=== Redis -> CSV
[source,shell]
----
riot redis --keyspace beer --keys id csv --file export-beers.csv --names id name brewery_id abv --header
----

== JSON Files
RIOT can read and write JSON data in the following format:
[source,plaintext]
----
[
  {
    // JSON object
  },
  {
    // JSON object
  }
]
----

=== JSON -> Redis
Here is an excerpt of `beers.json` available at https://github.com/rethinkdb/beerthink/blob/master/data/beers.json[beerthink]:
[source,json]
----
[
  {
    "id": "1",
    "brewery_id": "812",
    "name": "Hocus Pocus",
    "abv": "4.5",
    "style_name": "Light American Wheat Ale or Lager",
    "cat_name": "Other Style"
  },
  {
    "id": "6",
    "brewery_id": "1385",
    "name": "Winter Warmer",
    "abv": "5.199999809265137",
    "style_name": "Old Ale",
    "cat_name": "British Ale"
  }
]
----

[source,shell]
----
riot json --url https://raw.githubusercontent.com/rethinkdb/beerthink/master/data/beers.json redis --keyspace beer --keys id
----

[source,plaintext]
----
> HGETALL beer:1
 1) "last_mod"
 2) "2010-07-22 20:00:20 UTC"
 3) "style_name"
 4) "Light American Wheat Ale or Lager"
 5) "brewery_id"
 6) "812"
 …
----

=== JSON -> RediSearch
. Create an index with redis-cli
+
[source,plaintext]
----
FT.CREATE beers SCHEMA abv NUMERIC SORTABLE id TAG name TEXT PHONETIC dm:en style_name TEXT cat_name TEXT brewery_id TAG
----
. Import data into the index
+
[source,shell]
----
riot json --url https://raw.githubusercontent.com/rethinkdb/beerthink/master/data/beers.json redisearch --index beers --keys id
----
. Search for beers
+
[source,plaintext]
----
> FT.SEARCH beers "@abv:[7 9]"
 1) (integer) 500
 2) "5896"
 3)  1) cat_name
     2) "North American Ale"
     …
     7) style_name
     8) "American-Style Strong Pale Ale"
     …
    11) abv
    12) "7.099999904632568"
     …
----

=== Redis -> JSON
[source,shell]
----
riot redis --keyspace beer --keys id json --file export-beers.json
----

== Data Generators

=== Simple
The simple data generator generates entries with 2 fields by default:

* `index`: monotonous integer sequence
* `partition`: index of the partition (thread) generating the data, e.g. if you have 8 threads generating data each will have a different partition index between 0 and 7.

You can also configure it to generate fixed-sized fields with `--field <name=size>` options.

For example the following command generates hashes in the keyspace `test:<index>` with fields `value` and `value2` of respectively 10 and 100 bytes:
[source,shell]
----
riot simple --max 100 --field value=10 --field value2=100 redis --keyspace test --keys index
----

=== Faker
This data generator relies on the https://github.com/DiUS/java-faker[Faker] library. The supported data types are described here <<faker#,faker>>.

==== Example #1: People
[source,shell]
----
riot faker --max 100 --field id=sequence --field firstName=name.firstName --field lastName=name.lastName --field address=address.fullAddress redis --keyspace person --keys id
----
[source,plaintext]
----
> HGETALL person:1
1) "address"
2) "036 Robbin Points, North Sonia, PA 42251"
5) "firstName"
6) "Nickolas"
7) "lastName"
8) "Gleason"
---- 

==== Example #2: Game of Thrones
[source,shell]
----
riot faker --max 100 --field name=gameOfThrones.character redis --type set --keyspace got:characters --fields name
----
[source,plaintext]
----
> SMEMBERS got:characters
   1) "Nymella Toland"
   2) "Ysilla Royce"
   3) "Halmon Paege"
   4) "Mark Mullendore"
   5) "Cleyton Caswell"
   …
----

== Load Testing

=== Metrics
Use the `--metrics` option to show latency metrics when using the Lettuce driver:
[source,shell]
----
riot redis --metrics …
----
[source,plaintext]
----
{[local:any -> localhost/127.0.0.1:6379, commandType=SET]=[count=401, timeUnit=MICROSECONDS, firstResponse=[min=116, max=7274, percentiles={50.0=197, 90.0=458, 95.0=606, 99.0=1081, 99.9=7274}], completion=[min=128, max=8519, percentiles={50.0=219, 90.0=489, 95.0=634, 99.0=1122, 99.9=8519}]]}
{[local:any -> localhost/127.0.0.1:6379, commandType=SET]=[count=1403, timeUnit=MICROSECONDS, firstResponse=[min=48, max=704, percentiles={50.0=99, 90.0=156, 95.0=183, 99.0=280, 99.9=573}], completion=[min=49, max=909, percentiles={50.0=108, 90.0=171, 95.0=205, 99.0=317, 99.9=581}]]}
{[local:any -> localhost/127.0.0.1:6379, commandType=SET]=[count=1684, timeUnit=MICROSECONDS, firstResponse=[min=56, max=516, percentiles={50.0=80, 90.0=124, 95.0=142, 99.0=183, 99.9=391}], completion=[min=58, max=520, percentiles={50.0=82, 90.0=127, 95.0=146, 99.0=188, 99.9=403}]]}
----

=== Using Redis Enterprise
.Strings
[source,shell]
----
riot --host=redis-12000.redislabs.com --port=12000 --pool=96 --batch=500 --threads=96 simple --max=100000000 --field value=100 redis --type=string --format=raw --keyspace=string --keys=index --field=value
----
image::riot-performance-strings.png[]

.Streams
[source,shell]
----
riot --host=redis-12000.redislabs.com --port=12000 --pool=96 --batch=500 --threads=96 simple --max=100000000 redis --type=stream --keyspace=stream --keys=partition
----
image::riot-performance-streams.png[]